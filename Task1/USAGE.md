# Task 1 使用指南

## 快速开始

### 第一步：准备数据

在 `Task1/` 目录下创建 `data` 文件夹，结构如下：

```
Task1/
├── data/
│   ├── img/              # 存放所有图片
│   │   ├── glass_001.png
│   │   ├── glass_002.png
│   │   ├── glass_003.png
│   │   └── ...
│   └── label/            # 存放缺陷标注（txt文件）
│       ├── glass_001.txt  # 有此文件表示 glass_001.png 有缺陷
│       ├── glass_003.txt
│       └── ...
├── main.py
├── For_TA_test.py
└── README.md
```

**标签规则**：
- 如果图片 `glass_001.png` 有缺陷 → 在 `label/` 下创建 `glass_001.txt`（内容可为空）
- 如果图片 `glass_002.png` 无缺陷 → `label/` 下不要创建对应的 txt 文件

### 第二步：验证实现

运行验证脚本检查手动实现是否正确：

```bash
cd Task1
python test_implementation.py
```

**预期输出**：
```
测试 1: 前向传播
✓ 前向传播测试通过

测试 2: 反向传播
✓ 反向传播测试通过

测试 3: 参数更新
✓ 参数更新测试通过

测试 4: 数值梯度检查
数值梯度: 0.023456
解析梯度: 0.023455
差异: 0.00000123
✓ 梯度检查通过！反向传播实现正确

WhiteList 合规性检查
✓ 未发现违规项
```

### 第三步：训练模型

```bash
python main.py
```

**训练输出示例**：
```
==============================================================
Task 1: Binary Defect Classification - 训练开始
==============================================================
正在加载数据集，共 1000 张图片...
数据加载完成: 1000 张图片
类别分布 - 无缺陷: 850, 有缺陷: 150
训练集: 800 张, 验证集: 200 张

模型结构:
  输入层: 12288
  隐藏层: 128 (ReLU)
  输出层: 1 (Sigmoid)
  总参数量: 1572993

开始训练（共 50 轮）...
------------------------------------------------------------
Epoch [1/50] Train Loss: 0.4523 | Val Loss: 0.4201 | F1: 0.3214 | Precision: 0.4102 | Recall: 0.2658
Epoch [5/50] Train Loss: 0.3214 | Val Loss: 0.2987 | F1: 0.7532 | Precision: 0.7012 | Recall: 0.8124
...
Epoch [50/50] Train Loss: 0.1234 | Val Loss: 0.1521 | F1: 0.8756 | Precision: 0.8512 | Recall: 0.9012
------------------------------------------------------------
训练完成！最佳 F1-score: 0.8756
模型已保存到: ./model_weights.pth
```

### 第四步：测试模型

**重要**：在 `For_TA_test.py` 中修改你的学号：
```python
leader_id = 'PB23000000'  # 改为你的学号
```

运行测试：
```bash
python For_TA_test.py --test_data_path ./data
```

**输出**：
```
==============================================================
Task 1: Binary Defect Classification - 测试开始
==============================================================
模型加载成功: ./model_weights.pth
找到 1000 张测试图片
正在进行预测...

预测完成！
结果已保存到: PB23000000.json
共预测 1000 张图片
预测结果: 有缺陷 145 张, 无缺陷 855 张
```

检查生成的 JSON 文件：
```json
{
    "glass_001": true,
    "glass_002": false,
    "glass_003": true,
    ...
}
```

## 超参数调优建议

如果模型效果不好，可以在 [main.py](main.py) 中修改超参数：

### 1. 提高 F1-score

```python
# 增加正样本权重（如果模型倾向预测"无缺陷"）
POS_WEIGHT = 5.0  # 默认 3.0，可尝试 3-10

# 增大隐藏层（如果欠拟合）
HIDDEN_SIZE = 256  # 默认 128，可尝试 128-512

# 调整学习率
LEARNING_RATE = 0.0005  # 默认 0.001，可尝试 0.0001-0.01
```

### 2. 加快训练速度

```python
# 减小图片尺寸
IMG_SIZE = 32  # 默认 64，可尝试 32-128

# 减小隐藏层
HIDDEN_SIZE = 64  # 默认 128

# 增大批次
BATCH_SIZE = 64  # 默认 32
```

### 3. 防止过拟合

```python
# 减小隐藏层
HIDDEN_SIZE = 64

# 减少训练轮数
EPOCHS = 30  # 默认 50
```

## 常见错误排查

### 错误 1: FileNotFoundError

```
错误: 找不到图片目录: ./data/img
```

**解决**：确保数据目录结构正确：
```
Task1/data/img/     # 图片文件夹
Task1/data/label/   # 标签文件夹（可选）
```

### 错误 2: 模型全预测一个类别

**现象**：F1-score 为 0，模型全预测"无缺陷"

**原因**：类别不平衡

**解决**：增大 `POS_WEIGHT`（如 5.0 或 10.0）

### 错误 3: Loss 为 NaN

**原因**：学习率过大或梯度爆炸

**解决**：
- 降低学习率（如 0.0001）
- 检查梯度裁剪
- 确保 Sigmoid 输入被裁剪（`torch.clamp(z, -100, 100)`）

### 错误 4: JSON 格式错误

**错误的 JSON**：
```json
{
    "glass_001.png": true  // ✗ 不要带后缀
}
```

**正确的 JSON**：
```json
{
    "glass_001": true  // ✓ 不带后缀
}
```

## 代码合规性检查

在提交前，请确认：

- [ ] ❌ 代码中没有使用 `backward()`
- [ ] ❌ 代码中没有使用 `torch.optim.SGD` 或 `torch.optim.Adam`
- [ ] ❌ 代码中没有使用 `nn.Linear`、`nn.Conv2d`、`nn.Module`
- [ ] ✅ 只使用了 `torch.matmul`、`torch.randn`、`torch.zeros` 等基础操作
- [ ] ✅ 手动实现了前向传播和反向传播
- [ ] ✅ 手动实现了参数更新（SGD）

运行检查脚本：
```bash
python test_implementation.py
```

## 性能基准

在标准数据集上的参考性能（仅供参考）：

| 指标 | 数值 |
|------|------|
| Accuracy | 85-90% |
| Precision | 75-85% |
| Recall | 80-90% |
| **F1-score** | **78-87%** |

**说明**：
- F1-score 是主要评价指标
- 如果达到 75% 以上，说明模型基本可用
- 数据集不同，性能会有较大差异

## 技术支持

如果遇到问题，请检查：

1. 数据格式是否正确
2. 超参数是否合理
3. 运行验证脚本是否通过
4. 是否有使用禁止的 API

祝你顺利完成 Task 1！🎉
